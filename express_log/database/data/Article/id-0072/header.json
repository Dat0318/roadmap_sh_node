{
  "@id": "0072",
  "title": "Bài 4 - Sử Dụng Middleware",
  "short-title": "Bài 4 - Sử Dụng Middleware",
  "category-id": "09",
  "keywords": "lập trình web, hướng dẫn cơ bản, javascript, nodejs, expressjs",
  "content": "Trong bài viết này, chúng ta sẽ nói về việc sử dụng `middleware` - hay các `plug-in` xử lý trung gian trước khi yêu cầu được xử lý bởi các hàm tiếp nhận gắn tại `endpoint` và phản hồi lại cho phía trình duyệt web.\r\n\r\n## Cú pháp sử dụng middleware\r\n\r\nỒ... trước hết chúng ta cần biết một `middleware` hay một `plug-in` xử lý trung gian trông như thế nào đã. Ở đây chúng ta sẽ tạo ra một `plug-in` có tên là `logger` để in nhật ký tất cả các yêu cầu nhận được.\r\n\r\n```middleware/logger.js\r\nconst logger = function(request, response, next) {\r\n   var datetime = new Date();\r\n\r\n   console.log(\"= = = = = = = = = =\");\r\n   console.log(\"Datetime:\" + datetime.toString());\r\n   console.log(\"Request URL: \" + request.originalURL);\r\n   \r\n   next(); // chuyển quyền xử lý tới middleware tiếp thep\r\n}; // logger\r\n\r\nmodule.exports = logger;\r\n```\r\n\r\n```app.js\r\nconst express = require(\"express\");\r\nconst app = express();\r\n\r\nconst logger = require(\"./middleware/logger\");\r\nconst homeRouter = require(\"./route/home\");\r\n\r\napp.use(logger);\r\napp.use(\"/\", homeRouter);\r\n\r\napp.listen(3000);\r\n```\r\n\r\nBạn thấy đấy, một `middlware` về cơ bản là một hàm xử lý thông thường chứ không phải là một khái niệm mới. Tên gọi `middleware` chỉ là để phân biệt với các hàm xử lý cuối cùng đảm nhiệm tác vụ phản hồi lại yêu cầu với các phương thức của `response`.\r\n\r\nĐể gắn một `middleware` vào trước tất cả các tuyến `route` thì chúng ta có thể sử dụng phương thức `app.use(middleware)` ở vị trí trước khi gắn các `router` như trong code ví dụ ở trên. Trong trường hợp muốn sử dụng một `middleware` cho riêng một tuyến xử lý `route` nào đó thì chúng ta có thể sử dụng phương thức `router.use(middleware)` trước khi gắn hàm xử lý cho các phương thức tiếp nhận yêu cầu của `router`.\r\n\r\n```route/homeRouter.js\r\nconst express = require(\"express\");\r\nconst router = express.Router();\r\n\r\nconst checkLoginState = require(\"../middleware/login\");\r\n\r\nrouter.use(checkLoginState);\r\n\r\nrouter.get(\"/\", function(request, response, next) {\r\n   // ...\r\n});\r\n```\r\n\r\n## Một số middleware phổ biến\r\n\r\nNói đến các `plug-in` tiện ích của các thư viện và `framework` phổ biến, chắc chắn là chúng ta sẽ luôn có thể tìm thấy rất nhiều kết quả lựa chọn nếu Google một cách nghiêm túc. Với ExpressJS thì thao tác tìm kiếm của chúng ta có phần thuận lợi hơn với `npm` là nguồn cung cấp tin cậy bởi mặc định được phân phối kèm môi trường NodeJS.\r\n\r\nBên cạnh đó, ExpressJS có một hạng mục nhỏ được đặt ngay trên trang web của họ và liệt kê một số `middleware` phổ biến nhất để giúp người sử dụng tiết kiệm thời gian.\r\n\r\n[ExpressJS.com => Resouces => Middleware](https://expressjs.com/en/resources/middleware.html)\r\n![](https://images.viblo.asia/d6eeb15b-012e-4a01-ab47-8dcdd5003cc6.png)\r\n\r\n### a. morgan\r\n\r\nVí dụ đối với tác vụ in nhật ký các yêu cầu gửi đến `server` thì chúng ta có thể sử dụng một `middleware` có tên là `morgan` trong danh sách đó.\r\n\r\n```CMD-Terminal.io\r\nnpm install morgan --save\r\n```\r\n\r\n```app.js\r\nconst express = require(\"express\");\r\nconst app = express();\r\n\r\nconst logger = require(\"morgan\");\r\nconst homeRouter = require(\"./route/home\");\r\n\r\napp.use(logger);\r\napp.use(\"/\", homeRouter);\r\n\r\napp.listen(3000);\r\n```\r\n\r\n### b. serve-static\r\n\r\nMột `middleware` phổ biến khác nữa là `serve-static` được sử dụng để tự động xử lý các yêu cầu truy xuất các tệp tĩnh, ví dụ như các tệp `.css`, `.js`, v.v...\r\n\r\n```CMD-Terminal.io\r\nnpm install serve-static --save\r\n```\r\n\r\n```app.js\r\nconst path = require(\"path\");\r\nconst express = require(\"express\");\r\nconst serveStatic = require(\"serve-static\");\r\nconst homeRouter = require(\"./route/home\");\r\n\r\nconst staticFolder = path.join(__dirname, \"static\");\r\nconst staticServer = serveStatic(staticFolder);\r\n\r\nconst app = express();\r\napp.use(staticServer);\r\napp.use(\"/\", homeRouter);\r\n// ... other routers\r\n\r\napp.listen(3000);\r\n```\r\n\r\nNói riêng đối với tác vụ xử lý các yêu cầu tệp tĩnh thì ExpressJS cung cấp một `middleware` sẵn có là [express.static(path)](http://expressjs.com/en/4x/api.html#express.static).\r\n\r\n### c. cookie-parser\r\n\r\nMột `middleware` phổ biến được sử dụng để gắn các dữ liệu lưu trong `cookie` của trình duyệt web vào object `request`. Điều này giúp cho chúng ta có thể truy xuất các bản ghi `cookie` để xử lý các thao tác ví dụ như kiểm tra thông tin đăng nhập lần cuối của người dùng được lưu lại vào `cookie` bằng code JavaScript ở phía mặt tiền `client-side`.\r\n\r\n```CMD-Terminal.io\r\nnpm install cookie-parse --save\r\n```\r\n\r\n```app.js\r\nconst express = require(\"express\");\r\nconst homeRouter = require(\"./route/home\");\r\nconst cookieParser = require(\"cookie-parser\");\r\n\r\nconst app = express();\r\napp.use(cookieParser());\r\napp.use(\"/\", homeRouter);\r\n// ... other routers\r\n\r\napp.listen(3000);\r\n```\r\n\r\nSau khi gắn `cookieParser` thì các object `request` sẽ được gắn thêm các thuộc tính `request.cookies` và `request.signedCookies`.\r\n\r\n### d. compression\r\n\r\nMột `middleware` phổ biến được sử dụng để nén nội dung gửi phản hồi giúp giảm lượng băng thông chiếm dụng cho mỗi thao tác gửi dữ liệu phản hồi; Sẽ rất hữu ích khi blog của bạn đang xây dựng có nhiều người truy cập để đọc bài viết.\r\n\r\n```CMD-Terminal.io\r\nnpm install compression --save\r\n```\r\n\r\n```app.js\r\nconst express = require(\"express\");\r\nconst compression = require(\"compression\");\r\nconst homeRouter = require(\"./route/home\");\r\n\r\nconst app = express();\r\napp.use(compression());\r\napp.use(\"/\", homeRouter);\r\n\r\napp.listen(3000);\r\n```\r\n\r\n## Kết thúc bài viết\r\n\r\nBài viết giới thiệu về sử dụng `middleware` trong ExpressJS của chúng ta đến đây là kết thúc. Như vậy là tính tới thời điểm hiện tại thì chúng ta đã biết cách tạo ra một `server` với ExpressJS và thực hiện các thao tác điều hướng cơ bản để phân chia các kiểu yêu cầu về các tuyến xử lý `route`. Đồng thời, chúng ta cũng mới biết thêm được về cách gắn các `plug-in` xử lý trung gian cho `app` hoặc mỗi `route` để thực hiện các thao tác tiền xử lý hoặc tiện ích nào đó.\r\n\r\nTrong bài viết tiếp theo, chúng ta sẽ nói về phần mềm `express-generator` - giúp chúng ta nhanh chóng thiết lập một `project` mới với một số `plug-in` phổ biến và một vài thao tác thiết lập sẵn. Điều này giúp cho chúng ta có thể tiết kiệm thời gian và tập trung vào code xử lý chính của `server`, đồng thời tạo ra một dạng thức thư mục chung cho các `project` để có thể dễ dàng chia sẻ và sử dụng code.\r\n\r\n[[ExpressJS] Bài 5 - Express Generator](/article/view/0073/expressjs-bài-5---express-generator)"
}
